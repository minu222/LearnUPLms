<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org" xmlns="http://www.w3.org/1999/html">
<head>
    <meta charset="UTF-8">
    <title>회원 정보 수정</title>
</head>
<body>
<div th:fragment="content"
     th:with="

        rawUser=${ (user != null) ? user : (session.loginUser != null ? session.loginUser : null) },
        rawRole=${ (rawUser != null and rawUser.role != null) ? rawUser.role.toString() : null },
        role=${ rawRole == null ? null
               : #strings.toLowerCase(#strings.trim(#strings.replace(rawRole,'ROLE_',''))) }
     ">

    <!-- 사용자 없음(비로그인) 가드 -->
    <section th:if="${rawUser == null}" style="padding:24px;">
        <h2>로그인이 필요합니다</h2>
        <p>회원정보 수정은 로그인 후 이용 가능합니다.</p>
        <a class="btn btn-primary" th:href="@{/login}">로그인 하러가기</a>
    </section>

    <!-- 사용자 있음: 폼 렌더링 -->
        <!-- 개별 CSS (레이아웃에 없다면 유지) -->

        <main class="main-content" >
            <div class="header">
                <h1>회원 정보 수정</h1>
                <p>프로필 정보를 업데이트하세요</p>
            </div>

                <!-- 프로필 영역 -->
                <div class="profile-section">
                    <div class="profile-pic-wrapper">
                        <div class="profile-pic" onclick="document.getElementById('profileInput').click()">
                            <span class="plus-icon" id="plusIcon">+</span>
                            <img id="profileImage" src="#" alt="프로필 이미지" style="display:none;">
                        </div>
                        <!-- 이미지 업로드 사용 시: enctype 필요(아래 form 참고) -->
                        <input type="file" id="profileInput" name="profileImage" accept="image/*"
                               onchange="previewImage(event)" style="display:none;">
                    </div>
                    <div class="profile-info">
                        <h3 id="displayName" th:text="${rawUser != null ? rawUser.name : ''}">이름</h3>
                        <p id="displayEmail" th:text="${rawUser != null ? rawUser.email : ''}">email@example.com</p>
                    </div>
                </div>

                <!-- 저장 폼 -->
                <form class="form-grid"
                      th:action="@{/myclass/myInfo/update}"
                      method="post"
                      id="profileForm"
                      enctype="multipart/form-data">

                    <!-- CSRF -->
                    <input type="hidden" th:if="${_csrf != null}"
                           th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>

                    <!-- PK -->
                    <input type="hidden" name="user_id" th:value="${rawUser.user_id}"/>

                    <!-- 아이디(닉네임) 읽기전용 -->
                    <div class="input-group">
                        <label for="nickname">아이디</label>
                        <input type="text" id="nickname" class="input-field"
                               th:value="${rawUser.nickname}" readonly disabled>
                        <input type="hidden" name="nickname" th:value="${rawUser.nickname}">
                    </div>

                    <div class="row">
                        <!-- 비밀번호 변경은 별도 화면이 일반적; 여기선 비활성화 -->
                        <div class="input-group">
                            <label for="password">새 비밀번호</label>
                            <input type="password" id="password" name="password" class="input-field"
                                   placeholder="새 비밀번호" readonly>
                        </div>
                        <div class="input-group">
                            <label for="confirmPassword">비밀번호 확인</label>
                            <input type="password" id="confirmPassword" class="input-field"
                                   placeholder="비밀번호 확인" readonly>
                        </div>
                    </div>

                    <div class="input-group">
                        <label for="name">이름</label>
                        <input type="text" id="name" class="input-field" name="name"
                               th:value="${rawUser.name}" readonly>
                    </div>

                    <div class="input-group">
                        <label for="phone">핸드폰 번호</label>
                        <input type="text" id="phone" class="input-field" name="phone"
                               th:value="${rawUser.phone}" readonly>
                    </div>

                    <div class="input-group">
                        <label for="address">주소</label>
                        <input type="text" id="address" class="input-field" name="address"
                               th:value="${rawUser.address}" readonly>
                    </div>

                    <!-- detailAddress 컬럼이 실제 DB/엔티티에 없다면 name 제거 또는 주석 처리 -->
                    <div class="input-group">
                        <label for="detailAddress">상세주소</label>
                        <input type="text" id="detailAddress" class="input-field" readonly>
                    </div>

                    <div class="input-group">
                        <label for="email">이메일</label>
                        <input type="email" id="email" class="input-field" name="email"
                               th:value="${rawUser.email}" readonly>
                        <div class="field-error" th:if="${emailError}" th:text="${emailError}"
                             style="color:#c00;margin-top:4px;"></div>
                    </div>

                    <!-- 강사 전용 -->
                    <div th:if="${role == 'instructor' or role == 'teacher'}">
                        <h3 style="margin-top:16px;">강사 정보</h3>
                        <div class="input-group">
                            <label for="affiliation">소속</label>
                            <input type="text" id="affiliation" name="affiliation"
                                   class="input-field"
                                   th:value="${instructorProfile != null ? instructorProfile.affiliation : ''}"
                                   readonly>
                        </div>
                        <div class="input-group">
                            <label for="bio">자기소개</label>
                            <textarea id="bio" name="bio" class="input-field" rows="5" readonly
                                      th:text="${instructorProfile != null ? instructorProfile.bio : ''}"></textarea>
                        </div>
                    </div>

                    <!-- 수신동의(엔티티에 없으면 name 제거 또는 서버에서 무시) -->
                    <div class="checkbox-group" id="checkboxGroup">
                        <h4>수신 동의 설정</h4>
                        <div class="checkbox-item">
                            <label>
                                <input type="checkbox" id="emailAgree" name="emailAgree" disabled>
                                <span class="checkmark"></span>
                                이메일 수신 동의
                            </label>
                            <label style="margin-left:16px;">
                                <input type="checkbox" id="messageAgree" name="noteAgree" disabled>
                                <span class="checkmark"></span>
                                쪽지 수신 동의
                            </label>
                        </div>
                    </div>

                    <div class="button-group" style="margin-top:16px;">
                        <button type="button" class="btn btn-primary" id="editBtn">수정하기</button>
                        <div>
                            <button type="submit" class="btn btn-primary" id="saveBtn" disabled>저장하기</button>
                            <a th:href="@{/}" class="btn btn-secondary">닫기</a>
                        </div>
                    </div>
                </form>
        </main>


        <script>
            (function () {
                const $  = (sel, p = document) => p.querySelector(sel);

                const form    = $('#profileForm');
                const editBtn = $('#editBtn');
                const saveBtn = $('#saveBtn');
                const phone   = $('#phone');

                const editableSelectors = ['#password','#confirmPassword',
                    '#name','#phone','#address','#email','#affiliation','#bio'];
                const checkboxSelectors = ['#emailAgree', '#messageAgree'];

                let editing = false;

                function setEditable(on) {
                    editing = on;
                    editableSelectors.forEach(sel => { const el = $(sel); if (el) el.readOnly = !on; });
                    checkboxSelectors.forEach(sel => { const el = $(sel); if (el) el.disabled = !on; });
                    if (saveBtn) saveBtn.disabled = !on;
                    if (editBtn) editBtn.textContent = on ? '수정 취소' : '수정하기';
                }

                function validate() {
                    const pw  = $('#password')?.value || '';
                    const pw2 = $('#confirmPassword')?.value || '';
                    if (pw || pw2) {
                        if (pw.length < 8) { alert('비밀번호는 8자 이상'); $('#password').focus(); return false; }
                        if (pw !== pw2)   { alert('비밀번호가 일치하지 않습니다.'); $('#confirmPassword').focus(); return false; }
                    }
                    return true;
                }

                function sanitizePhoneKeepHyphen(s) {
                    if (!s) return '';
                    let t = String(s).replace(/[^\d-]/g, '');
                    t = t.replace(/-+/g, '-').replace(/^-|-$/g, '');
                    return t;
                }

                // 수정모드 토글
                editBtn?.addEventListener('click', () => setEditable(!editing));

                // ✅ 폼 제출 훅: 여기서 검증/정리 후 제출
                form?.addEventListener('submit', (e) => {
                    // 수정모드가 아니면(읽기전용) 그냥 막아버림
                    if (!editing) {
                        e.preventDefault();
                        alert('먼저 "수정하기"를 눌러 편집 모드로 전환하세요.');
                        return;
                    }
                    // 검증 실패 시 제출 중단
                    if (!validate()) {
                        e.preventDefault();
                        return;
                    }
                    // 전화번호 정리
                    if (phone) phone.value = sanitizePhoneKeepHyphen(phone.value);
                    // 그대로 제출 진행 (e.preventDefault() 안 했으므로 submit 됨)
                });

                // 입력 중 포맷
                phone?.addEventListener('input', () => {
                    if (!editing) return;
                    const only = phone.value.replace(/[^\d-]/g, '');
                    phone.value = only;
                });

                // 초기: 읽기전용
                setEditable(false);
            })();
        </script>
</div>
</body>
</html>
